
/**
 * Copyright (C) 2018 bind-js Haitham Mubarak 
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @BindJS is an easy implementation for data binding either bidirectional or one-way direction.
 * 
 */(function(){function f(b,a,d){Object.defineProperty(b,a,{value:d,writable:!1})}function u(b,a,d,c){if(c==n.TYPE.ATTRIBUTE)b.setAttribute(a,d);else for(a=a.split("."),c=0;c<a.length;c++){var e=a[c];if(c==a.length-1)if("function"==typeof b[e])b[e](d);else"object"==typeof b[e]?Object.assign(b[e],JSON.parse(d)):b[e]=d;else b=b[e]}}function v(b,a){for(var d=p[this.bindPath]||[],c=0;c<d.length;c++){var e=d[c];u(e.dom,e.key,this.getValue(),e.bindType)}}function w(b){var a=n.TYPE.PROPERTY;b.startsWith("@")&&
(b=b.substring(1),a=n.TYPE.ATTRIBUTE);return{key:b,type:a}}function x(b,a){var d=a||b.getAttribute("bindjs-value");d||(d="input"==b.tagName.toLowerCase()?"value":"innerText");return d}var r={},p={},n=function(b,a,d,c,e){for(var k={},l={},f=(b.getAttribute("bindjs-map")||"").split("|"),h=0;h<f.length;h++){var g=f[h],m=g.indexOf(":");m=-1==m?g.indexOf("="):m;if(-1!=m){var q=g.substring(0,m);g=g.substring(m+1);l[q]=g;k[g]=q}}var z=d.split(".");this.getValue=function(){if(a==n.TYPE.PROPERTY){var c=b;
for(var e=0;e<z.length;e++)c=c[z[e]];c="function"==typeof c?c():c;c=c!=b?c:null}else c=b.getAttribute(d);return k.hasOwnProperty(c)?k[c]:c};this.setValue=function(e){l.hasOwnProperty(e)&&(e=l[e]);e!=this.getValue()&&(u(b,d,e,a),b.dispatchEvent(new Event(c)))};var A=this;b.addEventListener(c,function(){v.apply(A,[])});v.apply(this,[]);this.dom=b;this.bindId=d;this.bindPath=e};n.TYPE={ATTRIBUTE:"attribute",PROPERTY:"property"};var t={context:function(b){var a=r;if("string"==typeof b)for(var d=b.split("."),
c=0;c<d.length;c++)if(a=a[d[c]],!a)throw Error("Unable to get context for "+b);return a},registerBindReference:function(b,a){if(a=a||b.getAttribute("bindjs-ref")){var d=a.split(":");if(1==d.length){var c=x(b,c);var e=d[0]}else 2<=d.length&&(c=d[0],e=d[1]);c=w(c);d=c.type;c=c.key;p[e]=p[e]||[];p[e].push({dom:b,key:c,bindType:d})}else throw Error("BindJS Reference is not defined.");},registerBind:function(b,a,d){var c="input"==b.tagName.toLowerCase()?"change":"DOMSubtreeModified";var e=x(b),k=b.getAttribute("bindjs-id");
try{if(!a){if(!k)throw Error("Unable to register bind with empty bind id.");for(;bindDomId.parentNode!=document;){var l=bindDomId.parentNode;l.hasAttribute("bindjs-id")&&(k=l.getAttribute("bindjs-id")+"."+k)}d=k;var y=k.split(".");a=r;for(l=0;l<y.length;l++){var h=y[l];a[h]||(a[h]={".":null});a=a[h]}}var g=w(e),m=g.type;e=g.key;f(a,"propertyNames",function(){return Object.keys(this.properties())});f(a,"properties",function(){for(var a={},c=Object.getOwnPropertyNames(this),b=0;b<c.length;b++){var d=
c[b];this.isProperty(d)&&(a[d]=!0)}return a});f(a,"isObject",function(){return 0<this.propertyNames().length});f(a,"isProperty",function(b){return b&&!b.startsWith(".")&&"function"!=typeof this[b]});f(a,"dom",function(){return this["."].dom});f(a,"bindPath",function(){return this["."].bindPath});f(a,"foreach",function(){handler.apply(this,[]);for(var b in this.properties())this.isProperty(b)&&this[b].foreach(handler)});f(a,"val",function(){if(0!=arguments.length&&1!=arguments.length)throw Error("Expected one or zero arguments.");
if(0==arguments.length){if(this.isObject()){var b=function(a,c){for(var d in c.properties())if(c.isProperty(d)){var e=c[d];e.isObject()?(a[d]={},b(a[d],e)):a[d]=e.val()}},a={};b(a,this);return JSON.stringify(a)}return this["."].getValue()}a=arguments[0];if(this.isObject()){var c=function(a,b){for(var d in b.properties())if(b.isProperty(d)){var e=b[d];e.isObject()?c(a[d],e):e.val(a[d])}};a="object"==typeof a?a:JSON.parse(arguments[0]+"");c(a,this)}else this["."].setValue(a)});f(a,".",new n(b,m,e,c,
d))}catch(q){throw console.log("Error at bind id :",k),q;}}};document.addEventListener("DOMContentLoaded",function(){function b(a,c,d){for(var e=0;e<a.children.length;e++){var h=a.children[e];if(h.hasAttribute("bindjs-id")){bindjsDomId=h.getAttribute("bindjs-id");f(c,bindjsDomId,{".":null});var g=d?d+"."+bindjsDomId:bindjsDomId;t.registerBind(h,c[bindjsDomId],g);b(h,c[bindjsDomId],g)}}}for(var a=document.body.querySelectorAll("[bindjs-ref]"),d=0;d<a.length;d++){var c=a[d];t.registerBindReference(c,
c.getAttribute("bindjs-ref"))}b(document.body,r,"")});window.BindJS=t})();
