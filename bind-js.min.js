
/**
 * Copyright (C) 2018 bind-js Haitham Mubarak 
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @BindJS is an easy implementation for data binding either bidirectional or one-way direction.
 * 
 */
(function(){function t(a,b,d){Object.defineProperty(a,b,{value:d,writable:!1})}function y(a,b,d,c){if(c==p.TYPE.ATTRIBUTE)a.setAttribute(b,d);else for(b=b.split("."),c=0;c<b.length;c++){var e=b[c];if(c==b.length-1)if("function"==typeof a[e])a[e](d);else"object"==typeof a[e]?Object.assign(a[e],JSON.parse(d)):a[e]=d;else a=a[e]}}function z(a,b){y(a.dom,a.key,b,a.bindType)}function u(a){var b=g.context(this.bindPath),d=b;if(!a){var c=!1;for(a={name:"contextchange",original:b,stopPropagation:function(){c=
!0}};null!=b&&!c;){if("function"==typeof b.onchange)b.onchange(a);b="function"==typeof b._parentContext?b._parentContext():null}}b=l[this.bindPath]||[];for(a=0;a<b.length;a++)z(b[a],d.val())}function A(a){var b=p.TYPE.PROPERTY;a.startsWith("@")&&(a=a.substring(1),b=p.TYPE.ATTRIBUTE);return{key:a,type:b}}function B(a,b){var d=b||a.getAttribute("bindjs-value");d||(d="input"==a.tagName.toLowerCase()?"value":"innerText");return d}function C(){function a(b,d,c){for(var e=0;e<b.children.length;e++){var f=
b.children[e];if(f.hasAttribute("bindjs-id")){bindjsDomId=f.getAttribute("bindjs-id");t(d,bindjsDomId,{".":null});var m=c?c+"."+bindjsDomId:bindjsDomId;g.registerBind(f,d[bindjsDomId],m);a(f,d[bindjsDomId],m)}else a(f,d,c)}}if(!v&&!D){v=!0;a(document.body,w,"");for(var b=document.body.querySelectorAll("[bindjs-ref]"),d=0;d<b.length;d++){var c=b[d];g.registerBindReference(c,c.getAttribute("bindjs-ref"))}v=!1;D=!0}}var E=/^[\-_a-zA-Z0-9]+$/,w={},l={},p=function(a,b,d,c,e){for(var f={},m={},g=(a.getAttribute("bindjs-map")||
"").split("|"),h=0;h<g.length;h++){var k=g[h],n=k.indexOf(":");n=-1==n?k.indexOf("="):n;if(-1!=n){var l=k.substring(0,n);k=k.substring(n+1);m[l]=k;f[k]=l}}var q=d.split(".");this.getValue=function(){if(b==p.TYPE.PROPERTY){var c=a;for(var e=0;e<q.length;e++)c=c[q[e]];c="function"==typeof c?c():c;c=c!=a?c:null}else c=a.getAttribute(d);return f.hasOwnProperty(c)?f[c]:c};this.setValue=function(c){m.hasOwnProperty(c)&&(c=m[c]);c!=this.getValue()&&(y(a,d,c,b),u.apply(r,[!0]))};var r=this;a.addEventListener(c,
function(){u.apply(r,[])});u.apply(this,[!0]);this.dom=a;this.bindId=d;this.bindPath=e};p.TYPE={ATTRIBUTE:"attribute",PROPERTY:"property"};var D=!1,v=!1,x=["onchange"],F={_parentContext:function(){var a=this.bindPath().replace(/(.*)\..+$/,"$1");return a!=this.bindPath()?g.context(a):null},_propertyNames:function(){return Object.keys(this._properties())},_properties:function(){for(var a={},b=Object.getOwnPropertyNames(this),d=0;d<b.length;d++){var c=b[d];this._isProperty(c)&&(a[c]=!0)}return a},_isObject:function(){return 0<
this._propertyNames().length},_isProperty:function(a){return a&&-1==x.indexOf(a)&&!a.startsWith(".")&&"function"!=typeof this[a]},dom:function(){return this["."].dom},bindPath:function(){return this["."].bindPath},foreach:function(){handler.apply(this,[]);for(var a in this._properties())this._isProperty(a)&&this[a].foreach(handler)},val:function(){if(0!=arguments.length&&1!=arguments.length)throw Error("Expected one or zero arguments.");if(0==arguments.length){if(this._isObject()){var a=function(b,
d){for(var c in d._properties())if(d._isProperty(c)){var e=d[c];e._isObject()?(b[c]={},a(b[c],e)):b[c]=e.val()}},b={};a(b,this);return JSON.stringify(b)}return this["."].getValue()}b=arguments[0];if(this._isObject()){var d=function(a,b){for(var c in b._properties())if(b._isProperty(c)){var e=b[c];e._isObject()?d(a[c],e):e.val(a[c])}};b="object"==typeof b?b:JSON.parse(arguments[0]+"");d(b,this)}else this["."].setValue(b)}};var g={context:function(a){C();var b=w;if("string"==typeof a)for(var d=a.split("."),
c=0;c<d.length;c++)if(b=b[d[c]],!b)throw Error("No context found for "+a);return b},registerBindReference:function(a,b){if(b=b||a.getAttribute("bindjs-ref")){var d=b.split(":");if(1==d.length){var c=B(a,c);var e=d[0]}else 2<=d.length&&(c=d[0],e=d[1]);c=A(c);d=c.type;c=c.key;l[e]=l[e]||[];c={dom:a,key:c,bindType:d};l[e].push(c);z(c,this.context(e).val())}else throw Error("BindJS Reference is not defined.");},registerBind:function(a,b,d){var c="input"==a.tagName.toLowerCase()?"change":"DOMSubtreeModified";
var e=B(a);try{var f=a.getAttribute("bindjs-id")||"";if(!f.match(E))throw Error('bindjs-id value "'+f+'" has wrong format. Values should match regex "'+E+'"');if(!b){if(!f)throw Error("Unable to register bind with empty bind id.");for(;bindDomId.parentNode!=document;){var m=bindDomId.parentNode;m.hasAttribute("bindjs-id")&&(f=m.getAttribute("bindjs-id")+"."+f)}d=f;var g=f.split(".");b=w;for(var h=0;h<g.length;h++){var k=g[h];b[k]||(b[k]={".":null});b=b[k]}}var n=A(e),l=n.type;e=n.key;for(h=0;h<x.length;h++)b[x[h]]=
null;for(var q in F)t(b,q,F[q]);t(b,".",new p(a,l,e,c,d))}catch(r){throw r;}}};document.addEventListener("DOMContentLoaded",function(){C()});window.BindJS=g})();
