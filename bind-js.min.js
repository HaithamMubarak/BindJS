
/**
 * Copyright (C) 2018 bind-js Haitham Mubarak 
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @BindJS is an easy implementation for data binding either bidirectional or one-way direction.
 * 
 */(function(){function g(b,c,d){Object.defineProperty(b,c,{value:d,writable:!1})}function u(b,c,d,a){if(a==n.TYPE.ATTRIBUTE)b.setAttribute(c,d);else for(c=c.split("."),a=0;a<c.length;a++){var e=c[a];if(a==c.length-1)if("function"==typeof b[e])b[e](d);else"object"==typeof b[e]?Object.assign(b[e],JSON.parse(d)):b[e]=d;else b=b[e]}}function v(b,c){for(var d=p[this.bindPath]||[],a=0;a<d.length;a++){var e=d[a];u(e.dom,e.key,this.getValue(),e.bindType)}}function w(b){var c=n.TYPE.PROPERTY;b.startsWith("@")&&
(b=b.substring(1),c=n.TYPE.ATTRIBUTE);return{key:b,type:c}}function x(b,c){var d=c||b.getAttribute("bindjs-value");d||(d="input"==b.tagName.toLowerCase()?"value":"innerText");return d}var r={},p={},n=function(b,c,d,a,e){for(var k={},l={},g=(b.getAttribute("bindjs-map")||"").split("|"),h=0;h<g.length;h++){var f=g[h],m=f.indexOf(":");m=-1==m?f.indexOf("="):m;if(-1!=m){var q=f.substring(0,m);f=f.substring(m+1);l[q]=f;k[f]=q}}var z=d.split(".");this.getValue=function(){if(c==n.TYPE.PROPERTY){var a=b;
for(var e=0;e<z.length;e++)a=a[z[e]];a="function"==typeof a?a():a;a=a!=b?a:null}else a=b.getAttribute(d);return k.hasOwnProperty(a)?k[a]:a};this.setValue=function(e){l.hasOwnProperty(e)&&(e=l[e]);e!=this.getValue()&&(u(b,d,e,c),b.dispatchEvent(new Event(a)))};var A=this;b.addEventListener(a,function(){v.apply(A,[])});v.apply(this,[]);this.dom=b;this.bindId=d;this.bindPath=e};n.TYPE={ATTRIBUTE:"attribute",PROPERTY:"property"};var t={context:function(b){var c=r;if("string"==typeof b)for(var d=b.split("."),
a=0;a<d.length;a++)if(c=c[d[a]],!c)throw Error("Unable to get context for "+b);return c},registerBindReference:function(b,c){if(c=c||b.getAttribute("bindjs-ref")){var d=c.split(":");if(1==d.length){var a=x(b,a);var e=d[0]}else 2<=d.length&&(a=d[0],e=d[1]);a=w(a);d=a.type;a=a.key;p[e]=p[e]||[];p[e].push({dom:b,key:a,bindType:d})}else throw Error("BindJS Reference is not defined.");},registerBind:function(b,c,d){var a="input"==b.tagName.toLowerCase()?"change":"DOMSubtreeModified";var e=x(b),k=b.getAttribute("bindjs-id");
try{if(!c){if(!k)throw Error("Unable to register bind with empty bind id.");for(;bindDomId.parentNode!=document;){var l=bindDomId.parentNode;l.hasAttribute("bindjs-id")&&(k=l.getAttribute("bindjs-id")+"."+k)}d=k;var y=k.split(".");c=r;for(l=0;l<y.length;l++){var h=y[l];c[h]||(c[h]={".":null});c=c[h]}}var f=w(e),m=f.type;e=f.key;g(c,"propertyNames",function(){return Object.keys(this.properties())});g(c,"properties",function(){for(var b={},c=Object.getOwnPropertyNames(this),a=0;a<c.length;a++){var d=
c[a];this.isProperty(d)&&(b[d]=!0)}return b});g(c,"isObject",function(){return 0<this.propertyNames().length});g(c,"isProperty",function(a){return a&&!a.startsWith(".")&&"function"!=typeof this[a]});g(c,"dom",function(){return this["."].dom});g(c,"bindPath",function(){return this["."].bindPath});g(c,"foreach",function(){handler.apply(this,[]);for(var a in this.properties())this.isProperty(a)&&this[a].foreach(handler)});g(c,"val",function(){if(0!=arguments.length&&1!=arguments.length)throw Error("Expected one or zero arguments.");
if(0==arguments.length){if(this.isObject()){var a=function(b,c){for(var d in c.properties())if(c.isProperty(d)){var e=c[d];e.isObject()?(b[d]={},a(b[d],e)):b[d]=e.val()}},b={};a(b,this);return JSON.stringify(b)}return this["."].getValue()}b=arguments[0];if(this.isObject()){var c=function(b,a){for(var d in a.properties())if(a.isProperty(d)){var e=a[d];e.isObject()?c(b[d],e):e.val(b[d])}};b="object"==typeof b?b:JSON.parse(arguments[0]+"");c(b,this)}else this["."].setValue(b)});g(c,".",new n(b,m,e,a,
d))}catch(q){throw console.log("Error at bind id :",k),q;}}};document.addEventListener("DOMContentLoaded",function(){function b(a,c,d){for(var e=0;e<a.children.length;e++){var h=a.children[e];if(h.hasAttribute("bindjs-id")){bindjsDomId=h.getAttribute("bindjs-id");g(c,bindjsDomId,{".":null});var f=d?d+"."+bindjsDomId:bindjsDomId;t.registerBind(h,c[bindjsDomId],f);b(h,c[bindjsDomId],f)}else b(h,c,f)}}for(var c=document.body.querySelectorAll("[bindjs-ref]"),d=0;d<c.length;d++){var a=c[d];t.registerBindReference(a,
a.getAttribute("bindjs-ref"))}b(document.body,r,"")});window.BindJS=t})();
